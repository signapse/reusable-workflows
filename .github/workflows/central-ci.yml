name: Standard CI

on:
  workflow_call:
    inputs:
      run-lint:
        description: "Run Super-Linter"
        required: false
        type: boolean
        default: true
      run-tests:
        description: "Run unit tests"
        required: false
        type: boolean
        default: true

jobs:
  detect-language:
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.language }}
    steps:
      - uses: actions/checkout@v4

      - id: detect
        run: |
          if [ -f "package.json" ]; then
            echo "language=node" >> $GITHUB_OUTPUT
          elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "language=python" >> $GITHUB_OUTPUT
          elif [ -f "go.mod" ]; then
            echo "language=go" >> $GITHUB_OUTPUT
          elif [ -f "Cargo.toml" ]; then
            echo "language=rust" >> $GITHUB_OUTPUT
          elif [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
            echo "language=java" >> $GITHUB_OUTPUT
          else
            echo "language=unknown" >> $GITHUB_OUTPUT
          fi

  install:
    runs-on: ubuntu-latest
    needs: detect-language
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        if: needs.detect-language.outputs.language == 'python'
        with:
          python-version: "3.x"

      - run: |
          pip install --upgrade pip
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
        if: needs.detect-language.outputs.language == 'python'

      - run: npm ci
        if: needs.detect-language.outputs.language == 'node'

      - run: go mod download
        if: needs.detect-language.outputs.language == 'go'

      - run: cargo fetch
        if: needs.detect-language.outputs.language == 'rust'

      - run: mvn install -DskipTests
        if: needs.detect-language.outputs.language == 'java'

  lint:
    runs-on: ubuntu-latest
    needs: install
    if: ${{ inputs.run-lint }}
    steps:
      - uses: actions/checkout@v4
      - uses: github/super-linter/slim@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: true

  test:
    runs-on: ubuntu-latest
    needs: install
    if: ${{ inputs.run-tests }}
    steps:
      - uses: actions/checkout@v4

      - run: pytest || python -m unittest discover
        if: needs.detect-language.outputs.language == 'python'

      - run: npm test
        if: needs.detect-language.outputs.language == 'node'

      - run: go test ./...
        if: needs.detect-language.outputs.language == 'go'

      - run: cargo test --all
        if: needs.detect-language.outputs.language == 'rust'

      - run: mvn test
        if: needs.detect-language.outputs.language == 'java'