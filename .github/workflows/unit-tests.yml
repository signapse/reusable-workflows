name: Universal Unit Tests
'on':
  workflow_call:
    inputs:
      python-version:
        description: Python version
        required: false
        type: string
        default: '3.12'
      node-version:
        description: Node.js version
        required: false
        type: string
        default: '18'
      java-version:
        description: Java version
        required: false
        type: string
        default: '17'
jobs:
  detect-language:
    runs-on: ubuntu-latest
    outputs:
      language: '${{ steps.detect.outputs.language }}'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - id: detect
        run: |
          if [ -f "package.json" ]; then
            echo "language=node" >> $GITHUB_OUTPUT
          elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "language=python" >> $GITHUB_OUTPUT
          elif [ -f "go.mod" ]; then
            echo "language=go" >> $GITHUB_OUTPUT
          elif [ -f "Cargo.toml" ]; then
            echo "language=rust" >> $GITHUB_OUTPUT
          elif [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
            echo "language=java" >> $GITHUB_OUTPUT
          else
            echo "language=unknown" >> $GITHUB_OUTPUT
  tests:
    runs-on: ubuntu-latest
    needs: detect-language
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        if: needs.detect-language.outputs.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '${{ inputs.python-version }}'
      - name: Cache Python dependencies
        if: needs.detect-language.outputs.language == 'python'
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: '${{ runner.os }}-pip-${{ hashFiles(''**/requirements.txt'') }}'
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Python dependencies
        if: needs.detect-language.outputs.language == 'python'
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
      - name: Run Python tests
        if: needs.detect-language.outputs.language == 'python'
        run: python -m unittest discover -s tests -p "*.py"
      - name: Set up Node.js
        if: needs.detect-language.outputs.language == 'node'
        uses: actions/setup-node@v3
        with:
          node-version: '${{ inputs.node-version }}'
      - name: Cache Node modules
        if: needs.detect-language.outputs.language == 'node'
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: '${{ runner.os }}-node-${{ hashFiles(''**/package-lock.json'') }}'
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install Node dependencies
        if: needs.detect-language.outputs.language == 'node'
        run: npm ci
      - name: Run Node tests
        if: needs.detect-language.outputs.language == 'node'
        run: npm test
      - name: Set up Go
        if: needs.detect-language.outputs.language == 'go'
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Cache Go modules
        if: needs.detect-language.outputs.language == 'go'
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/go/bin
          key: '${{ runner.os }}-go-${{ hashFiles(''**/go.sum'') }}'
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Install Go dependencies
        if: needs.detect-language.outputs.language == 'go'
        run: go mod tidy
      - name: Run Go tests
        if: needs.detect-language.outputs.language == 'go'
        run: go test ./...
      - name: Set up Rust
        if: needs.detect-language.outputs.language == 'rust'
        uses: actions/setup-rust@v2
        with:
          rust-version: 1.75.0
      - name: Install Rust dependencies
        if: needs.detect-language.outputs.language == 'rust'
        run: cargo fetch
      - name: Run Rust tests
        if: needs.detect-language.outputs.language == 'rust'
        run: cargo test --all
      - name: Set up Java
        if: needs.detect-language.outputs.language == 'java'
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '${{ inputs.java-version }}'
      - name: Cache Maven dependencies
        if: needs.detect-language.outputs.language == 'java'
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: '${{ runner.os }}-maven-${{ hashFiles(''**/pom.xml'') }}'
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Install Java dependencies
        if: needs.detect-language.outputs.language == 'java'
        run: mvn install -DskipTests
      - name: Run Java tests
        if: needs.detect-language.outputs.language == 'java'
        run: mvn test
