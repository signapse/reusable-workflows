name: Deploy Docker Image

on:
  workflow_call:
    inputs:
      service_type:
        description: 'AWS service type (lambda, ecs, eks)'
        required: true
        type: string

      service_name:
        description: 'Service/function name (Lambda function name, ECS service name, EKS deployment name)'
        required: true
        type: string

      image_uri:
        description: 'Full Docker image URI including tag (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com/my-app:v1.0.0)'
        required: true
        type: string

      aws_region:
        description: 'AWS region'
        required: true
        type: string

      iam_role_arn:
        description: 'IAM role ARN for AWS authentication via OIDC'
        required: true
        type: string

      # Optional parameters for specific services
      cluster_name:
        description: '[ECS/EKS] Cluster name'
        required: false
        type: string
        default: ''

      namespace:
        description: '[EKS] Kubernetes namespace'
        required: false
        type: string
        default: 'default'

      container_name:
        description: '[EKS] Container name in the deployment'
        required: false
        type: string
        default: ''

      wait_for_completion:
        description: 'Wait for deployment to complete'
        required: false
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.iam_role_arn }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ inputs.aws_region }}

      - name: Validate service type
        run: |
          VALID_TYPES="lambda ecs eks"
          if [[ ! " $VALID_TYPES " =~ " ${{ inputs.service_type }} " ]]; then
            echo "‚ùå Error: Invalid service_type '${{ inputs.service_type }}'"
            echo "Valid types: $VALID_TYPES"
            exit 1
          fi
          echo "‚úÖ Service type: ${{ inputs.service_type }}"

      # ========================================
      # Lambda Deployment
      # ========================================
      - name: Deploy to AWS Lambda
        if: inputs.service_type == 'lambda'
        run: |
          echo "=========================================="
          echo "üöÄ Deploying to AWS Lambda"
          echo "=========================================="
          echo "Function: ${{ inputs.service_name }}"
          echo "Image: ${{ inputs.image_uri }}"
          echo "Region: ${{ inputs.aws_region }}"
          echo "=========================================="

          aws lambda update-function-code \
            --function-name "${{ inputs.service_name }}" \
            --image-uri "${{ inputs.image_uri }}" \
            --publish

          echo "‚úÖ Lambda function updated"

      - name: Wait for Lambda deployment
        if: inputs.service_type == 'lambda' && inputs.wait_for_completion
        run: |
          echo "‚è≥ Waiting for Lambda function to be ready..."

          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            STATUS=$(aws lambda get-function \
              --function-name "${{ inputs.service_name }}" \
              --query 'Configuration.LastUpdateStatus' \
              --output text)

            echo "Attempt $((attempt + 1))/$max_attempts - Status: $STATUS"

            if [ "$STATUS" == "Successful" ]; then
              echo "‚úÖ Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" == "Failed" ]; then
              echo "‚ùå Deployment failed!"
              aws lambda get-function \
                --function-name "${{ inputs.service_name }}" \
                --query 'Configuration.LastUpdateStatusReason'
              exit 1
            fi

            attempt=$((attempt + 1))
            sleep 10
          done

          echo "‚ùå Timeout waiting for deployment"
          exit 1

      - name: Get Lambda function details
        if: inputs.service_type == 'lambda'
        run: |
          echo "=========================================="
          echo "üìã Lambda Function Details"
          echo "=========================================="
          aws lambda get-function \
            --function-name "${{ inputs.service_name }}" \
            --query 'Configuration.{Name:FunctionName,Version:Version,State:State,LastModified:LastModified}' \
            --output table
          echo "=========================================="

      # ========================================
      # ECS Deployment
      # ========================================
      - name: Deploy to ECS
        if: inputs.service_type == 'ecs'
        run: |
          if [ -z "${{ inputs.cluster_name }}" ]; then
            echo "‚ùå Error: cluster_name is required for ECS deployments"
            exit 1
          fi

          echo "=========================================="
          echo "üöÄ Deploying to Amazon ECS"
          echo "=========================================="
          echo "Cluster: ${{ inputs.cluster_name }}"
          echo "Service: ${{ inputs.service_name }}"
          echo "Image: ${{ inputs.image_uri }}"
          echo "=========================================="

          # Force new deployment with the new image
          aws ecs update-service \
            --cluster "${{ inputs.cluster_name }}" \
            --service "${{ inputs.service_name }}" \
            --force-new-deployment

          echo "‚úÖ ECS service update initiated"

      - name: Wait for ECS deployment
        if: inputs.service_type == 'ecs' && inputs.wait_for_completion
        run: |
          echo "‚è≥ Waiting for ECS service to stabilize..."

          aws ecs wait services-stable \
            --cluster "${{ inputs.cluster_name }}" \
            --services "${{ inputs.service_name }}"

          echo "‚úÖ ECS deployment completed successfully!"

      - name: Get ECS service details
        if: inputs.service_type == 'ecs'
        run: |
          echo "=========================================="
          echo "üìã ECS Service Details"
          echo "=========================================="
          aws ecs describe-services \
            --cluster "${{ inputs.cluster_name }}" \
            --services "${{ inputs.service_name }}" \
            --query 'services[0].{Name:serviceName,Status:status,Running:runningCount,Desired:desiredCount}' \
            --output table
          echo "=========================================="

      # ========================================
      # EKS Deployment
      # ========================================
      - name: Deploy to EKS
        if: inputs.service_type == 'eks'
        run: |
          if [ -z "${{ inputs.cluster_name }}" ]; then
            echo "‚ùå Error: cluster_name is required for EKS deployments"
            exit 1
          fi

          echo "=========================================="
          echo "üöÄ Deploying to Amazon EKS"
          echo "=========================================="
          echo "Cluster: ${{ inputs.cluster_name }}"
          echo "Deployment: ${{ inputs.service_name }}"
          echo "Namespace: ${{ inputs.namespace }}"
          echo "Image: ${{ inputs.image_uri }}"
          echo "=========================================="

          # Configure kubectl
          aws eks update-kubeconfig \
            --name "${{ inputs.cluster_name }}" \
            --region "${{ inputs.aws_region }}"

          # Determine container name (use input or deployment name)
          CONTAINER_NAME="${{ inputs.container_name }}"
          if [ -z "$CONTAINER_NAME" ]; then
            CONTAINER_NAME="${{ inputs.service_name }}"
          fi

          # Update deployment image
          kubectl set image deployment/${{ inputs.service_name }} \
            $CONTAINER_NAME=${{ inputs.image_uri }} \
            --namespace ${{ inputs.namespace }}

          echo "‚úÖ EKS deployment updated"

      - name: Wait for EKS deployment
        if: inputs.service_type == 'eks' && inputs.wait_for_completion
        run: |
          echo "‚è≥ Waiting for EKS rollout to complete..."

          kubectl rollout status deployment/${{ inputs.service_name }} \
            --namespace ${{ inputs.namespace }} \
            --timeout=10m

          echo "‚úÖ EKS deployment completed successfully!"

      - name: Get EKS deployment details
        if: inputs.service_type == 'eks'
        run: |
          echo "=========================================="
          echo "üìã EKS Deployment Details"
          echo "=========================================="
          kubectl get deployment ${{ inputs.service_name }} \
            --namespace ${{ inputs.namespace }} \
            --output wide
          echo ""
          kubectl get pods \
            --namespace ${{ inputs.namespace }} \
            --selector=app=${{ inputs.service_name }} \
            --output wide
          echo "=========================================="

      # ========================================
      # Deployment Summary
      # ========================================
      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "‚ú® Deployment Summary"
          echo "=========================================="
          echo "Service Type: ${{ inputs.service_type }}"
          echo "Service Name: ${{ inputs.service_name }}"
          echo "Image URI: ${{ inputs.image_uri }}"
          echo "Region: ${{ inputs.aws_region }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "=========================================="
