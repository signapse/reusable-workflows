name: Dev Portal - Build and Deploy to EKS with Helm

on:
  push:
    branches:
      - main
      - develop
  release:
    types: [published]

permissions:
  id-token: write
  contents: read

jobs:
  # ========================================
  # Build and Push Docker Image
  # ========================================
  build-development:
    if: github.event_name == 'push' || (github.event_name == 'release' && github.event.action == 'published')
    uses: signapse/reusable-workflows/.github/workflows/build-and-push-ecr.yml@main
    with:
      ecr_repository_uri: "827204657141.dkr.ecr.eu-west-2.amazonaws.com/dev-portal"
      aws_region: "eu-west-2"
      iam_role_arn: "arn:aws:iam::827204657141:role/github-actions-connect"
      image_tag: ${{ github.event_name == 'release' && github.event.release.tag_name || github.sha }}
      push_latest: false
    permissions:
      id-token: write
      contents: read

  # ========================================
  # Deploy to Development EKS with Helm
  # ========================================
  deploy-dev-helm:
    needs: build-development
    uses: signapse/reusable-workflows/.github/workflows/deploy-eks-helm.yml@main
    with:
      # AWS Configuration
      aws_region: "eu-west-2"
      iam_role_arn: "arn:aws:iam::887333319954:role/github-access"

      # EKS Configuration
      cluster_name: "dev-cluster"
      namespace: "dev-portal"
      create_namespace: true

      # Helm Configuration
      release_name: "dev-portal"
      chart_path: "./helm/dev-portal"  # Path to your Helm chart in the repo
      values_file: "./helm/values-dev.yaml"  # Path to your values file

      # Image Configuration (override image in values file)
      image_uri: "827204657141.dkr.ecr.eu-west-2.amazonaws.com/dev-portal:${{ github.event_name == 'release' && github.event.release.tag_name || github.sha }}"

      # Deployment Options
      atomic: true
      wait: true
      timeout: "10m"

      # Additional overrides using set_values
      set_values: |
        replicaCount=2
        autoscaling.enabled=true
        autoscaling.minReplicas=2
        autoscaling.maxReplicas=10

    permissions:
      id-token: write
      contents: read

  # ========================================
  # Deploy to Production EKS with Helm (only on release)
  # ========================================
  deploy-prod-helm:
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: build-development
    uses: signapse/reusable-workflows/.github/workflows/deploy-eks-helm.yml@main
    with:
      # AWS Configuration
      aws_region: "eu-west-2"
      iam_role_arn: "arn:aws:iam::887333319954:role/github-access"

      # EKS Configuration
      cluster_name: "prod-cluster"
      namespace: "production"
      create_namespace: true

      # Helm Configuration
      release_name: "dev-portal"
      chart_path: "./helm/dev-portal"
      values_file: "./helm/values-prod.yaml"

      # Image Configuration
      image_uri: "827204657141.dkr.ecr.eu-west-2.amazonaws.com/dev-portal:${{ github.event.release.tag_name }}"

      # Deployment Options
      atomic: true
      wait: true
      timeout: "15m"

      # Production overrides
      set_values: |
        replicaCount=3
        autoscaling.enabled=true
        autoscaling.minReplicas=3
        autoscaling.maxReplicas=20
        resources.requests.cpu=1000m
        resources.requests.memory=1Gi
        resources.limits.cpu=2000m
        resources.limits.memory=2Gi

    permissions:
      id-token: write
      contents: read
