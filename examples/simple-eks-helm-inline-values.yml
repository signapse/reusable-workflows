name: Simple EKS Helm Deployment with Inline Values

# This example shows how to use inline values instead of a values file
# Useful for simple deployments or when you want everything in one file

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy-with-inline-values:
    uses: signapse/reusable-workflows/.github/workflows/deploy-eks-helm.yml@main
    with:
      # AWS Configuration
      aws_region: "eu-west-2"
      iam_role_arn: "arn:aws:iam::887333319954:role/github-access"

      # EKS Configuration
      cluster_name: "${{ inputs.environment }}-cluster"
      namespace: "dev-portal"
      create_namespace: true

      # Helm Configuration
      release_name: "dev-portal"
      chart_path: "./helm/dev-portal"

      # Image Configuration
      image_uri: "827204657141.dkr.ecr.eu-west-2.amazonaws.com/dev-portal:${{ inputs.image_tag }}"

      # Inline values (YAML format)
      values_inline: |
        replicaCount: 2

        namespace: dev-portal

        image:
          repository: 827204657141.dkr.ecr.eu-west-2.amazonaws.com/dev-portal
          pullPolicy: IfNotPresent
          tag: "${{ inputs.image_tag }}"

        serviceAccount:
          create: true
          automount: true
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::887333319954:role/dev-portal-sa-role

        podLabels:
          app: dev-portal
          environment: ${{ inputs.environment }}

        service:
          type: ClusterIP
          port: 4443
          targetPort: 3000

        ingress:
          enabled: true
          className: kong
          annotations:
            konghq.com/protocols: https
            konghq.com/strip-path: "false"
          hosts:
            - host: docs.${{ inputs.environment }}.signapsesolutions.com
              paths:
                - path: /
                  pathType: Prefix

        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi

        env:
          - name: API_BASE_URL
            value: "https://dev-portal.api.${{ inputs.environment }}.signapsesolutions.com"
          - name: PORT
            value: "3000"
          - name: NODE_ENV
            value: "${{ inputs.environment }}"

        autoscaling:
          enabled: true
          minReplicas: 2
          maxReplicas: 10
          targetCPUUtilizationPercentage: 60

      # Deployment Options
      atomic: true
      wait: true
      timeout: "10m"

    permissions:
      id-token: write
      contents: read
