# Text2Gloss Deployment Workflow
#
# Copy this file to your text2gloss repo at: .github/workflows/deploy.yml
#
# Before using:
# 1. Replace 'your-org' with your actual GitHub organization name
# 2. Ensure these secrets are set in your GitHub repo:
#    - LAMBDA_NAME_DEV (your dev Lambda function name)
#    - LAMBDA_NAME_PROD (your prod Lambda function name)
# 3. Update prod IAM role if production uses a different AWS account
# 4. Set up a "production" environment in GitHub repo settings with required approvers

name: Build and Deploy Text2Gloss

on:
  release:
    types: [published]

permissions:
  id-token: write
  contents: read

jobs:
  # Step 1: Build Docker image and push to ECR
  build:
    name: Build and Push to ECR
    uses: your-org/reusable-workflows/.github/workflows/build-and-push-ecr.yml@main
    with:
      ecr_repository_uri: "827204657141.dkr.ecr.eu-west-2.amazonaws.com/text2gloss"
      aws_region: "eu-west-2"
      iam_role_arn: "arn:aws:iam::827204657141:role/github-actions-connect"
      image_tag: ${{ github.event.release.tag_name }}
      # No docker_build_args needed - Dockerfile doesn't use any build arguments
    permissions:
      id-token: write
      contents: read

  # Step 2: Deploy to Dev environment
  deploy-dev:
    name: Deploy to Dev
    needs: build
    uses: your-org/reusable-workflows/.github/workflows/deploy-docker-image.yml@main
    with:
      service_type: lambda
      image_uri: 827204657141.dkr.ecr.eu-west-2.amazonaws.com/text2gloss:${{ github.event.release.tag_name }}
      aws_region: eu-west-2
      iam_role_arn: arn:aws:iam::887333319954:role/github-access
      wait_for_completion: true
    secrets:
      service_name_secret: ${{ secrets.LAMBDA_NAME_DEV }}
    permissions:
      id-token: write
      contents: read

  # Step 3: Deploy to Production (requires manual approval)
  deploy-prod:
    name: Deploy to Production
    needs: deploy-dev
    environment: production  # Requires GitHub environment with approvers
    uses: your-org/reusable-workflows/.github/workflows/deploy-docker-image.yml@main
    with:
      service_type: lambda
      image_uri: 827204657141.dkr.ecr.eu-west-2.amazonaws.com/text2gloss:${{ github.event.release.tag_name }}
      aws_region: eu-west-2
      iam_role_arn: arn:aws:iam::887333319954:role/github-access  # Update if prod uses different AWS account
      wait_for_completion: true
    secrets:
      service_name_secret: ${{ secrets.LAMBDA_NAME_PROD }}
    permissions:
      id-token: write
      contents: read
